#include <physical_layouts.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>

/ {
    chosen {
        zmk,kscan = &composite_kscan;
        zmk,physical-layout = &default_layout;
    };

    /* Zephyr gpio-qdec encoder devices - handles quadrature decoding */
    encoder_left: encoder_left {
        compatible = "gpio-qdec";
        gpios = <&gpio0 3 (GPIO_PULL_UP | GPIO_ACTIVE_HIGH)>,
                <&gpio0 4 (GPIO_PULL_UP | GPIO_ACTIVE_HIGH)>;
        steps-per-period = <4>;
        zephyr,axis = <INPUT_REL_X>;
        sample-time-us = <2000>;
        idle-timeout-ms = <200>;
    };

    encoder_right: encoder_right {
        compatible = "gpio-qdec";
        gpios = <&gpio0 6 (GPIO_PULL_UP | GPIO_ACTIVE_HIGH)>,
                <&gpio0 7 (GPIO_PULL_UP | GPIO_ACTIVE_HIGH)>;
        steps-per-period = <4>;
        zephyr,axis = <INPUT_REL_Y>;
        sample-time-us = <2000>;
        idle-timeout-ms = <200>;
    };

    /* QDEC kscan driver - consumes gpio-qdec input events
     * Outputs: row = encoder index, col 0 = CW, col 1 = CCW
     *   Row 0: Left encoder  - col 0 = CW, col 1 = CCW
     *   Row 1: Right encoder - col 0 = CW, col 1 = CCW
     */
    encoder_rotation_kscan: encoder_rotation_kscan {
        compatible = "zmk,kscan-gpio-qdec";
        devices = <&encoder_left &encoder_right>;
        axes = <INPUT_REL_X INPUT_REL_Y>;
    };

    /* Encoder button switches
     * Outputs: row 0, col = button index
     *   Row 0, Col 0 = Left button
     *   Row 0, Col 1 = Right button
     */
    encoder_kscan: encoder_kscan {
        compatible = "zmk,kscan-gpio-direct";
        input-gpios = <&gpio0 5 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>,
                      <&gpio0 8 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
    };

    /* Composite kscan combining encoder buttons and rotations
     *
     * Final matrix layout (3 rows Ã— 2 columns):
     *   Row 0: Left button (col 0), Right button (col 1)  <- from encoder_kscan
     *   Row 1: Left CW (col 0), Left CCW (col 1)          <- from rotation row 0
     *   Row 2: Right CW (col 0), Right CCW (col 1)        <- from rotation row 1
     */
    composite_kscan: composite_kscan {
        compatible = "zmk,kscan-composite";
        rows = <3>;
        columns = <2>;

        encoder_switches {
            kscan = <&encoder_kscan>;
            row-offset = <0>;
        };

        encoder_rotations {
            kscan = <&encoder_rotation_kscan>;
            row-offset = <1>;
        };
    };

    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <2>;
        rows = <3>;
        /* Map: RC(row, col) -> keymap position
         *   Position 0 = RC(0,0) = Left button
         *   Position 1 = RC(0,1) = Right button
         *   Position 2 = RC(1,0) = Left CW
         *   Position 3 = RC(1,1) = Left CCW
         *   Position 4 = RC(2,0) = Right CW
         *   Position 5 = RC(2,1) = Right CCW
         */
        map = <
            0 1
            2 3
            4 5
        >;
    };

    default_layout: default_layout {
        compatible = "zmk,physical-layout";
        display-name = "Encoder Pad";
        transform = <&default_transform>;
        kscan = <&composite_kscan>;

        keys  //                    w   h   x    y    rot  rx   ry
            // Encoder buttons (row 0)
            = <&key_physical_attrs 100 100   0    0    0    0    0>  // 0: Left encoder button
            , <&key_physical_attrs 100 100 150    0    0    0    0>  // 1: Right encoder button
            // Left encoder rotations (row 1)
            , <&key_physical_attrs  80  50   0  120    0    0    0>  // 2: Left CW
            , <&key_physical_attrs  80  50   0  180    0    0    0>  // 3: Left CCW
            // Right encoder rotations (row 2)
            , <&key_physical_attrs  80  50 150  120    0    0    0>  // 4: Right CW
            , <&key_physical_attrs  80  50 150  180    0    0    0>  // 5: Right CCW
            ;
    };
};

&zephyr_udc0 {
    status = "okay";
};
